---
title: "Projet INFO0808 – Visualisation de données"
author: "FUZELLIER Maxence, BARBET Antoine"
date: "04/03/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r packages, message=FALSE, include=FALSE}
# install.packages(c('tidyverse', 'knitr', 'rmarkdown', 'markdown', 'data.table', 'plotly', 'viridis', 'hrbrthemes', 'lubridate'))
# setwd("C:/Users/Hapoc/Desktop/M1 INFO/INFO0808 - Visualisation de données/info0808_project")
```

Import des packages :
```{r load, message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)
library(rmarkdown)
library(markdown)
library(data.table)
library(plotly)
library(viridis) # color palettes for readability and colorblindness
library(hrbrthemes)
library(lubridate)
```

Chargement des jeux de données :
```{r datasets, message=FALSE}
df_anime <- fread(file='datasets/anime_filtered.csv')
df_users <- fread(file='datasets/users_filtered.csv')
```

```{r bbl_100, echo=TRUE}
bbl_chart <- df_anime[df_anime$popularity!=0] %>% 
  arrange(rank) %>% head(n = 100) %>%
  select(popularity, rank, title, scored_by, favorites, score) %>%
  filter(popularity <= 100) %>%
  mutate(point = (as.numeric(scored_by) * as.numeric(favorites) * as.numeric(score)) / 10^10) %>% 
  ggplot(aes(x=rank, y=popularity, size=point, color=popularity, text=title)) +
  geom_point(alpha=0.7) +
  scale_size(range = c(1.4, 19)) +
  scale_color_viridis() +
  theme_ipsum() +
  theme(
    axis.title.x = element_text(size=14),
    axis.title.y = element_text(size=14)
  ) +
  scale_x_continuous(
    limits = c(0,100),
    breaks = seq(0,100,10)
  ) +
  scale_y_continuous(
    limits = c(-5,100),
    breaks = seq(0,100,10)
  ) +
  labs(title='In Terms Of Rank And Popularity TOP 100 Animes', x='Rank', y='Popularity')

bbl_chart <- ggplotly(bbl_chart, tooltip=c('rank', 'popularity'))
bbl_chart
```

```{r line_100, echo=TRUE, fig.height=6, fig.width=20, message=FALSE, warning=FALSE}
point_plot_pop <- df_anime[df_anime$popularity!=0] %>%
  arrange(popularity) %>% head(n = 100) %>% 
  select(title, popularity, rank) %>%
  ggplot(aes(x=popularity, y=rank)) +
  geom_line(color='black') +
  geom_point(size=2, color='red') +
  theme_ipsum() +
  theme(axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14)) +
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(-1,101),
    breaks=seq(0,100,5)
  ) +
  scale_y_continuous(
    breaks = seq(0,3000,500),
    limits = c(0,3000)
  ) +
  ggtitle('Top 100 anime with their rank score')
  

# turn ggplot interactive with plotly
point_plot_pop <- ggplotly(point_plot_pop, tooltip=c('rank', 'popularity'))
point_plot_pop
```

```{r}
point_plot_pop %>% filter(popularity == 17)
```

```{r score_note, echo=TRUE, message=FALSE, warning=TRUE}
rs_score_notes <- df_anime %>%
  filter(airing == F & scored_by > 99) %>%
  ggplot(aes(x=scored_by, y=score)) +
  stat_bin_hex(bins = 50) +
  theme_ipsum() +
  scale_fill_viridis() +
  stat_smooth(
    method = 'lm',
    color = 'red',
    formula = y ~ log(x)
  ) +
  theme(
    axis.title.x = element_text(size=14),
    axis.title.y = element_text(size=14)
  ) +
  scale_y_continuous(
    limits = c(2,9.5),
    breaks = seq(2,9.5)
  ) +
  ggtitle('Relationship between Score and Scored_by')

rs_score_notes <- ggplotly(rs_score_notes)
rs_score_notes
```

```{r score_source, echo=TRUE, message=FALSE, warning=TRUE}
median_val <- df_anime %>% 
  select(scored_by, score) %>% 
  filter(scored_by > 99) %>% 
  summarize(median_sc = median(score))


score_source <- df_anime %>% 
  filter(airing == F & scored_by > 99) %>%
  select(score, scored_by, source) %>%
  ggplot(aes(x=source, y=score)) +
  geom_boxplot(fill='deepskyblue') + 
  geom_hline(aes(yintercept=median_val[[1]], linetype="median")) +
  scale_linetype_manual(name='', values=c(median='dashed')) +
  coord_flip() + 
  theme_ipsum() +
  theme(
    axis.title.x = element_text(size=14),
    axis.title.y = element_blank(),
  ) +
  scale_y_continuous(limits = c(0,10)) +
  ggtitle('Score Distribution by Source')

score_source <- ggplotly(score_source)
score_source
```

```{r score_type, echo=TRUE, message=FALSE, warning=TRUE}
score_type <- df_anime %>% 
  filter(airing == F & scored_by > 99) %>%
  select(score, scored_by, type) %>%
  ggplot(aes(x=type, y=score)) +
  geom_boxplot(fill='deepskyblue') + 
  geom_hline(aes(yintercept=median_val[[1]], linetype="median")) +
  scale_linetype_manual(name='', values=c(median='dashed')) +
  coord_flip() + 
  theme_ipsum() +
  theme(
    axis.title.x = element_text(size=14),
    axis.title.y = element_blank(),
  ) +
  scale_y_continuous(limits = c(0,10)) +
  ggtitle('Score Distribution by Type')

score_type <- ggplotly(score_type)
score_type
```


```{r users}
users <- df_users[df_users$gender %in% c('Female','Male') & !is.null(users$birth_date)] %>% 
  select(username, gender, user_completed, user_days_spent_watching, birth_date)

users$age <- as.period(interval(start=users$birth_date, end=as.Date(now())))$year
```

```{r box_gender_age, echo=TRUE, message=FALSE, warning=FALSE}
box_gender_age <- users %>% 
  ggplot(aes(x=gender, y=age, fill=gender)) +
  geom_boxplot() +
  theme_ipsum() +
  theme(
    legend.position='none',
    axis.title.x = element_text(size=14),
    axis.title.y = element_text(size=14)
  ) +
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(-1,60),
    breaks=seq(0,60,5)
  ) +
  ggtitle("Users' age by gender")

box_gender_age <- ggplotly(box_gender_age)
box_gender_age
```

```{r box_gender_spent, echo=TRUE, message=FALSE, warning=FALSE}
box_gender_spent <- users %>% 
  ggplot(aes(x=gender, y=user_days_spent_watching, fill=gender)) +
  geom_boxplot() +
  theme_ipsum() +
  theme(
    legend.position='none',
    axis.title.x = element_text(size=14),
    axis.title.y = element_text(size=14)
  ) +
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(-1,301),
    breaks=seq(0,300,50)
  ) +
  ggtitle("Users' days spent by gender")

box_gender_spent <- ggplotly(box_gender_spent)
box_gender_spent
```

```{r scatter_age, echo=TRUE, fig.height=6, fig.width=20, message=FALSE, warning=FALSE}
scatter_age <- users %>%
  ggplot(aes(x=age, y=user_days_spent_watching, color=gender)) +
  geom_point(alpha=0.5) +
  theme_ipsum() +
  scale_color_manual(values=c('red', 'blue')) +
  theme(
    legend.position='none',
    axis.title.x = element_text(size=14),
    axis.title.y = element_text(size=14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(-1,81),
    breaks=seq(0,80,5)
  ) +
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(-1,1001),
    breaks=seq(0,1000,200)
  ) +
  ggtitle("Anime watchers' age")
  
scatter_age <- ggplotly(scatter_age)
scatter_age
```

