---
title: "Projet INFO0808 – Visualisation de données"
author: "FUZELLIER Maxence, BARBET Antoine"
date: "04/03/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r packages, message=FALSE, include=FALSE}
# install.packages(c('tidyverse', 'knitr', 'rmarkdown', 'markdown', 'data.table', 'plotly', 'viridis', 'hrbrthemes', 'lubridate'))
# setwd("C:/Users/Hapoc/Desktop/M1 INFO/INFO0808 - Visualisation de données/info0808_project")
```

Import des packages :
```{r load, message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)
library(rmarkdown)
library(markdown)
library(data.table)
library(plotly)
library(viridis) # color palettes for readability and colorblindness
library(hrbrthemes)
library(lubridate)
```

Chargement des jeux de données :
```{r datasets, message=FALSE}
df_anime <- fread(file='datasets/anime_filtered.csv')
df_users <- fread(file='datasets/users_filtered.csv')
df_userlists <- fread(file='datasets/animelists_filtered.csv')
```

```{r data, echo=TRUE}
anime <- df_anime[!is.null(df_anime$genre)] %>% 
  select(anime_id, title, type, source, score, scored_by, rank, popularity, genre)

users <- df_users[df_users$gender %in% c('Female','Male')] %>% 
  select(username, gender, user_completed, user_days_spent_watching, birth_date)

userlists <- df_userlists[df_userlists$my_status %in% c(1,2) & !is.null(df_userlists$anime_id)] %>% 
  select(username, anime_id, my_score)

userlists <- inner_join(userlists, users)
userlists <- left_join(userlists, anime)

userlists_sub <- userlists[!is.null(userlists$genre)] %>% head(n = 100000)
head(userlists_sub)
```

```{r anime_rank, echo=TRUE}
anime_rank_100 <- df_anime[df_anime$popularity!=0] %>% 
  arrange(rank) %>% head(n = 100) %>%
  select(popularity, rank, title, type, source, scored_by, favorites, score) %>%
  filter(popularity <= 100) %>%
  mutate(point = (as.numeric(scored_by) * as.numeric(favorites) * as.numeric(score)) / 10000000000)

anime_rank_100
```

```{r bbl_100, echo=TRUE}
bbl_chart <- anime_rank_100 %>% 
  ggplot(aes(x=rank, y=popularity, size=point, color=popularity, text=title)) +
  geom_point(alpha=0.7) +
  scale_size(range = c(1.4, 19)) +
  scale_color_viridis() +
  labs(title='In Terms Of Rank And Popularity TOP 100 Animes', x='Rank', y='Popularity') +
  theme_ipsum() +
  theme(axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14)) +
  scale_x_continuous(
    limits = c(0,100),
    breaks=seq(0,100,10)
  ) +
  scale_y_continuous(
    limits = c(-5,100),
    breaks=seq(0,100,10)
  )

bbl_chart <- ggplotly(bbl_chart, tooltip=c('rank', 'popularity'))
bbl_chart
```

```{r line_100, echo=TRUE, fig.height=6, fig.width=20, message=FALSE, warning=FALSE}
point_plot_pop <- df_anime[df_anime$popularity!=0] %>%
  arrange(popularity) %>% head(n = 100) %>% 
  select(title, popularity, rank) %>%
  ggplot(aes(x=popularity, y=rank)) +
  geom_line(color='black') +
  geom_point(size=2, color='red') +
  theme_ipsum() +
  theme(axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14)) +
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(-1,101),
    breaks=seq(0,100,5)
  ) +
  scale_y_continuous(
    breaks = seq(0,3000,500),
    limits = c(0,3000)
  ) +
  ggtitle('Top 100 anime with their rank score')
  

# turn ggplot interactive with plotly
point_plot_pop <- ggplotly(point_plot_pop, tooltip=c('rank', 'popularity'))
point_plot_pop
```

```{r}
point_plot_pop %>% filter(popularity == 17)
```

```{r users}
users <- users[!is.null(users$birth_date)]
users$age <- as.period(interval(start=users$birth_date, end=as.Date(now())))$year
```

```{r box_gender_age, echo=TRUE, message=FALSE, warning=FALSE}
box_gender_age <- users %>% 
  ggplot(aes(x=gender, y=age, fill=gender)) +
  geom_boxplot() +
  theme_ipsum() +
  theme(
    legend.position='none',
    axis.title.x = element_text(size=14),
    axis.title.y = element_text(size=14)
  ) +
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(-1,60),
    breaks=seq(0,60,5)
  ) +
  ggtitle("Users' age by gender")

box_gender_age <- ggplotly(box_gender_age)
box_gender_age
```

```{r box_gender_spent, echo=TRUE, message=FALSE, warning=FALSE}
box_gender_spent <- users %>% 
  ggplot(aes(x=gender, y=user_days_spent_watching, fill=gender)) +
  geom_boxplot() +
  theme_ipsum() +
  theme(
    legend.position='none',
    axis.title.x = element_text(size=14),
    axis.title.y = element_text(size=14)
  ) +
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(-1,301),
    breaks=seq(0,300,50)
  ) +
  ggtitle("Users' days spent by gender")

box_gender_spent <- ggplotly(box_gender_spent)
box_gender_spent
```

```{r scatter_age, echo=TRUE, fig.height=6, fig.width=20, message=FALSE, warning=FALSE}
scatter_age <- users %>%
  ggplot(aes(x=age, y=user_days_spent_watching, color=gender)) +
  geom_point(alpha=0.5) +
  theme_ipsum() +
  scale_color_manual(values=c('red', 'blue')) +
  theme(
    legend.position='none',
    axis.title.x = element_text(size=14),
    axis.title.y = element_text(size=14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  scale_x_continuous(
    expand = c(0, 0),
    limits = c(-1,81),
    breaks=seq(0,80,5)
  ) +
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(-1,1001),
    breaks=seq(0,1000,200)
  ) +
  ggtitle("Anime watchers' age")
  
scatter_age <- ggplotly(scatter_age)
scatter_age
```

